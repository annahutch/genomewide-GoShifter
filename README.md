# genomewide-GoShifter
Code to implement an extension of the GoShifter methodology so that it can be performed on all SNPs genome-wide (rather than index SNPs + LD friends as in the original method).

Note: This is an extension of the GoShifter method originally developed by Trynka et al. (2015) (https://doi.org/10.1016/j.ajhg.2015.05.016)

This repo is really for my own personal use, but in case others want to use it I include a brief description of each script and how to run them.

### GoShifter-funcs.R
* Contains code for the shifter and my_GoShifter functions

### run-GoShifter.R
* Run this to implement GoShifter (as a slurm array job for 1 to how many LD blocks the full set of SNPs reside in).
* Requires GWAS p-values, a binary vector of annotations (usually in (q=1) or out (q=0) of the genomic feature), which LD block each SNP resides (1,..,n), MAF for each SNP, distance to nearest gene for each SNP.
* Results for each LD block are stored in res/ directory.
* Results for each array job (LD block) are .RDS files containing lists of GoShifter statistics for each stratification (SNPs are further stratified by MAF and distance to nearest gene).

### MakeFinalStats.R
* Run this after run-GoShifter.R to generate a "final_test_statistics.RDS" file which contains the observed test statistic (for the observed SNP-annotation overlap) and a vector of test statistics computed under the null (from random permutations of the annotation vector).

---

## Extra details

(the following text is taken from my PhD thesis)

GoShifter (Genomic Annotation Shifter) (Trynka et al. 2015) is a statistical method to test for SNP enrichment that uses an innovative approach to account for confounding. Specifically, each loci is circularised and the annotation data is randomly "shifted" within the loci to calculate the null distribution of test statistics (if an annotation is shifted beyond the boundaries of the locus, it re-emerges the other side).  As input, GoShifter requires (i) a list of lead SNPs from a GWAS of interest and (ii) annotation data (in BED format) for which to examine SNP enrichment. Loci are defined as the genomic regions encompassing all variants in LD with each lead SNP (for example $r^2>0.8$ using a representative reference panel) and these are then extended by twice the median size of the tested annotation to ensure that the loci also contain SNPs not linked to the lead SNP. The proportion of loci containing a SNP which overlaps the annotation is calculated, and this quantity is used as the observed test statistic. The null distribution of test statistics is generated by randomly shifting the annotation data and re-calculating the proportion of loci containing a SNP which overlaps the shifted annotation. This is repeated for many iterations to generate many test statistics which comprise the null distribution. The formulation of the null distribution in this way preserves key confounding parameters relating to the spatial distribution of genomic features (such as gene density and gene proximity), but does not require that these are specified in advance, or even known $\textit{a priori}$ at all. A $p$-value for SNP enrichment is then calculated as the proportion of iterations where the calculated test statistic was greater than or equal to the observed test statistic.

The GoShifter method was primarily developed to ascertain the functional annotations which differentiate causal from trait-associated variants (Trynka et al. 2015). However, it only leverages lead SNPs and those in LD with these, which may limit power. Indeed, the GARFIELD method (Iotchkva et al. 2019) which uses a user-specified GWAS $p$-value threshold to determine SNP inclusion, found that some enrichments were only identified when using a more liberal $p$-value inclusion criteria (e.g. $p<1\times 10^{-5}$). This implies that as the statistical power to detect more trait-associated variant increases, many more enrichments may be uncovered. Moreover, since it is generally recognised that the majority of trait-associated SNPs remain undiscovered \citep{visscher2017}, leveraging all common variants to test for SNP enrichment is a sensible approach to increase power. For these reasons, I decided to extend the GoShifter methodology so that it could be applied to all GWAS SNPs, rather than only those in high LD with the index SNPs from the GWAS.

The main consideration for my method was the formulation of a new test statistic, since the GoShifter test statistic is no longer applicable (as my loci cover the whole genome, rather than just those containing lead SNPs from a GWAS). I constructed a test statistic which compares the mean $-log_{10}(p)$ value for SNPs residing in the annotation ($p_1$) and the mean $-log_{10}(p)$ value for SNPs not overlapping the annotation ($p_0$), respectively. Let $n_1$ be the number of SNPs overlapping the annotation and $n_0$ be the number of SNPs not overlapping an annotation, then the overall test statistic is

\begin{equation}
X=\dfrac{\dfrac{\sum_{i=1}^N {p_1}_i \times {n_1}_i}{\sum_{i=1}^N {n_1}_i}}{\dfrac{\sum_{i=1}^N {p_0}_i \times {n_0}_i}{\sum_{i=1}^N {n_0}_i}}
\end{equation}

where $N$ is the total number of SNP stratifications (which are described later). Thus, higher values of the overall test statistic implies that SNPs residing within the annotation have on average smaller $p$-values than those not residing in the annotation. The overall test statistic is computed for the observed SNP-annotation overlap to derive the observed test statistic. 

In order to assess the significance of the observed test statistic, "null" test statistics are derived by circularising and randomly permuting the annotation data within each SNP stratification and calculating $p_0$ and $p_1$ for this annotation-permuted configuration, to derive the value of $X$ ($n_0$ and $n_1$ are already calculated when deriving the observed test statistic). The magnitude of the permutation is generated by randomly sampling an integer from a uniform distribution between 0 and the number of SNPs in the SNP stratification. This is repeated 1000 times for each SNP stratification. To generate an estimate of the overall test statistic under the null distribution, I take a random sample of a permutation for each SNP stratification and use $p_1$ and $p_0$ in Equation 1. I do this $10,000$ times to generate $10,000$ test statistics computed under the null distribution.

